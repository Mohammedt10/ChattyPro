<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="CONTENT-TYPE" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Chatty</title>
  <style>
    body {
      margin:0;
      padding: 0;
      user-select: none;
      background: #fefefe;
      background: url('chat-bg.jpg');
      background-attachment: fixed;
      background-repeat: repeat;
      background-position: center;
      background-size: contain;
      user-select: none;
      font-family: Arial;
    }
    .welcomeScreenContainer {
      position: fixed;
      width: 100%;
      height: 100svh;
      background: rgba(10, 10, 10, 0.5);
      backdrop-filter: blur(4px);
      top: 0;
      left: 0;
      z-index: 9999;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .welcomeScreen {
      width: 90%;
      max-width: 500px;
      height: 500px;
      background-image: linear-gradient(145deg, orange, yellow);
      border-radius: 12px;
    }
    .welcomeLogoContainer {
      
      text-align: center;
      margin: 28px 18px 30px 0;
      line-height: 1.4;
    }
    .welcomeLogoContainer > img {
      width: 90%;
      aspect-ratio: 12/3;
    }
    .welcomeContentContainer {
      text-align: center;
    }
    .welcomeContentContainer h1 {
      text-align: center;
      font-family: Arial;
      font-size: 28px;
      padding: 6px 12px;
      line-height: 1.6;
      color: white;
      background: #7264B8;
    }
    .welcomeContentContainer h1 span:first-of-type {
      color: #ffa500ee;
      font-size: 30px;
      background: ;
      padding: 4px;
      border-top-right-radius: 6px;
      border-bottom-left-radius: 6px;
    }
    .welcomeContentContainer p {
      font-size: 20px;
      font-weight: 500;
      color: #404040;
      margin-top: 30px;
      line-height: 1.4;
    }
    .welcomeContentContainer label:first-of-type {
      margin-top: 8px;
      margin-bottom: 14px;
    }
    .welcomeContentContainer label {
      font-size: 20px;
      display: inline-block;
      color: midnightblue;
      margin-right: 10px;
      font-weight: 600;
      color: #404040;
    }
    .welcomeContentContainer input {
      border: none;
      outline: none;
      background: ;
      font-size: 16px;
      width: 40%;
      background: #7264B822;
      padding: 7px 10px;
      border-radius: 8px;
      color: #7a00ff;
      text-align: center;
      font-weight: 500;
    }
    .welcomeContentContainer button {
      display: block;
      margin: 0 auto;
      margin-top: 30px;
      border: none;
      padding: 12px 64px;
      border-radius: 9999px;
      font-size: 18px;
      color: #fff;
      background: #7264B8;
      box-shadow: 0 2px 0 0 #7264b877;
      outline: none;
      font-weight: 500;
    }
    .welcomeContentContainer button:active {
      box-shadow: none;
      transform: translateY(2px);
    }
    .crown-shape {
      display: inline-flex;
      width: 20px;
      height: 20px;
      background-color: gold;
      margin-right: 8px;
      margin-left: 4px;
      clip-path: polygon(0% 70%,20% 20%,33% 70%,50% 10%,67% 70%,80% 20%,100% 70%, 100% 100%,0% 100%);
    }
    .profilePic {
      height: 40px;
      width: 40px;
      border-radius: 9999px;
      background: white;
      position: absolute;
      bottom: 0;
      left: -46px;
    }

    header .onlineBox .onlineCount {
      font-size: 18px; 
      font-family: Arial;
      border-radius: 15px;
      padding: 8px 14px;
      color: #fff;
      display: flex;
      font-weight: 500;
      justify-content: center;
      align-items: center;
      background: #404040;
      box-shadow: 0 0 0 1px #0001;
      color: rgb(20,255,20);
    }
    .onlineBox > span {
      margin-right: 4px;
      font-weight: 500;
      color: rgb(20, 255, 20);
    }
    header {
      width: 100%;
      display: flex;
      justify-content: space-around;
      align-items: center;
      background: #a33e5a;
      background: #6c556a55;
      position: fixed; 
      top: 0;
      color: #fff;
      padding: 8px;
      box-shadow: 1px 0 1px 0 rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(8px);
      z-index: 9999;
    }
    .logo-div {
      font-weight: 700;
      font-size: 22px;
      letter-spacing: -1px;
    }
    .main {      
      width: 100%;
      padding-top: 50px;
      padding-bottom: 90px;
    }
    .messageBox {
      position: fixed;
      width: 100%;
      bottom: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 0px;
      padding: 10px 0;
      background: transparent;
      backdrop-filter: blur(8px);
      gap: 6px;
    }
    .messageBox input {
      width: 70%;
      margin-left: ;
      border-radius: 999px;
      border: 1px solid #fff;
      outline: none;
      padding: 18px 0;
      padding-left: 16px;
      padding-right: 10px;
      font-size: 17px;
      background: transparent;
      color: #ddd;
    }
    .messageBox input::placeholder {
      color: #aaa;
    }
    .messageBox button {
      border: none;
      border-radius: 999px;
      font-size: 30px;
      background-image: linear-gradient(90deg, #628BFF, #43CFEA);
      color: #fff;
      box-shadow: 0 0 1px 0 rgba(0, 0, 0, 0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 14px 16px;
    }
    .messageBox button:active {
      opacity: 0.9;
    }
    .notMe, .me {
    margin: 20px 16px;
    width: fit-content;
    max-width: 75%;
    line-height: 22px;
    word-wrap: break-word;
    padding: 25px 25px;
    color: #fff;
    border-radius: 50px;
    font-size: 16px;
    text-align: left;
}
    .meParent {
      text-align: right;      
    }
    .notMe {
      border-bottom-left-radius: 0;
      background: #ffffff22;
      color: #ddd;
      backdrop-filter: blur(4px);
      position: relative;
      margin-left: 55px;
      max-width: 60%;
      margin-bottom: 35px;
    }
    .timeSpanText {
      position: absolute;
      content: '';
      left: 0;
      bottom: -25px;
      color: #ccc;
      font-size: 14px;
    }
    .me > span {
      left: auto;
      right: 0;
    }
    .me {
      display: inline-block;
      position: relative;
      border-bottom-left-radius: ;
      border-bottom-right-radius: 0;
      background-image: linear-gradient(90deg, #628BFF, #43CFEA);
      margin-bottom: 16px;
    }
    .noText {
      position: absolute;
      font-size: 20px;
      top: 100px;
      color: #909090aa;
      left: 50%;
      transform: translateX(-50%);
      white-space: nowrap;
      backdrop-filter: blur(2px);
      background: #70707040;
      padding: 8px;
      border-radius: 12px;
      border: 1px solid #404040ee;
    }
    .usernameText {
      padding: 0;
      margin: 0;
      padding-bottom: 12px;
      color: #fff;
      font-weight: 700;
      font-size: 17px;
    }
    .img-div img {
      height: 100%;
    }
    .img-div {
      height: 24px;
      width: 24px;
      margin-bottom: 4px;
    }
    .logo-div img {
      width: 125px;
    }
    .notMe:active, .me:active {
      opacity: 0.9;
    }
    .profilePicViewer {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(20, 20, 20, 0.5);
      z-index: 99999;
      display: flex;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(4px);
    }
    .profilePicViewed {
      width: 270px;
      height: 270px;
      box-shadow: 0 1px 5px #20202050;
      border-radius: 9999px;
    }
    .menu-container {
      display: none;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      gap: 6px;
      position: fixed;
      right: 10px;
      top: 13px;
      z-index: 99999;
   
    }
    .menu-container > span {
      height: 5px;
      width: 5px;
      border-radius: 2.5px;
      background: #bbb;
    }
    .settings {
      height: 400px;
      width: 240px;
      background: #404040;
      border: 2px solid #505050;
      border-radius: 8px;
      position: fixed;
      right: 16px;
      top: 10%;
      z-index: 99999;
      display: none;
      padding: 16px 12px;
      box-sizing: border-box;
    }
    .settingsToggle {
      display: block;
    }
       
    .confirmBtn {
      display: block;
      margin: 0 auto;
      margin-top: 30px;
      border: none;
      padding: 10px 28px;
      border-radius: 9999px;
      font-size: 14px;
      color: #fff;
      background: #606060;
      box-shadow: 0 2px 0 #60606060;
      outline: none;
      font-weight: 500;
    }
    .confirmBtn:active {
      box-shadow: none;
      transform: translateY(2px);
    } 
    
    @media screen and (max-width: 350px) {
      .me, .notMe {
        padding: 18px 16px;
      }
      .logo-div img {
        width: 110px;
      }
      .onlineCount {
        padding: 6px !important;
        font-size: 12px !important;
        margin-right: 16px !important;
      }
      .usernameText {
        margin-left: 20px;
      }
    }
    @media screen and (max-width: 767px){
      body {
        background-repeat: no-repeat;
        background-size: cover;
      }
    }
    
    @media screen and (min-width: 1023px) {
      .notMe, .me {
        margin-right: 140px;
        margin-left: 140px;
        max-width: 30%;
        font-size: 18px;
        line-height: 24px;
      }
      .messageBox {
        gap: 20px;
      }
      body {
        background-repeat: repeat;
        background-position: center;
        background-size: contain;
      }
      .profilePicViewed {
        width: 400px;
        height: 400px;
      }
    }
  </style>
</head>
<body>

    <div class="menu-container">
      <span></span>
      <span></span>
      <span></span>
    </div>
  
  <div class="settings">
    
    <div style="text-align:center;color:white;">
      <img id="currentProfileImg" style="position:static;height:80px;width:80px;border-radius:40px;" class="profilePic" onerror="this.src='profilePic.png'">
      <h3 id="usernameh3">Username</h3>
    </div>
    <hr style="border:none;border-top: 1px solid #eee">
    <div style="color:#ccc;">
      <h4 style="margin-top:44px;margin-bottom:14px;">Edit:</h4>
        
      Username:<input style="margin-left:7px;width:55%;outline:none" maxlength='15' id="currentUsername">
      Photo Link: <input style="margin-top:8px;width:55%;outline:none" id="currentLink">
    <br>
    <button class="confirmBtn">Confirm</button>
    </div> 
  </div>


    <div class="welcomeScreenContainer">
    <div class="welcomeScreen">
      <div class="welcomeLogoContainer">
        <img src="logo.png">
      </div>
      
      <div class="welcomeContentContainer">
        <h1><span>Welcome</span> to your live chat hub!</h1>
        <p>(Optional fields)</p>
          <label for="usernameInput">Username:</label>&nbsp;&nbsp;&nbsp;
          <input type="text" autocomplete="off" id="usernameInput" maxlength="15">
          <br>
          <label for="profilePicInput">Picture link:</label>
          <input type="text" autocomplete="off" id="profilePicInput">
          
          <button class="continueBtn">Continue</button>
        
      </div>
    </div>
  </div>



  <header>
    <div class="logo-div">
      <img src="logo.png" alt="chatty logo">
    </div>
  <div class="onlineBox">
    <div class="onlineBox">
    <div class="onlineCount">
   online:&nbsp;<span id="onlineNum">?</span> 
   </div>
  </div>
    </header>
    <div class="noText" onclick="message.value = 'Hello everyone!';profilePicSrc = profilePicInput.value;sendBtn.click();message.blur();">Start messaging..</div>
  
  <main class="main">    
  </main>
  
  <div class="messageBox">
    <input placeholder="Message..." autocomplete="off" id="inputMessage"><button id="sendBtn"><div class="img-div"><img src="send.png"></div></button>
  </div>
  
  <script src="/socket.io/socket.io.js"></script>
  <script>

  let realUsername = '';
  let profilePicSrc = '';  
  const chattyBotHTML = `
      <p class="usernameText" style="color:gold;font-weight:900;font-size:20px;text-shadow: 0 1px 0 goldenrod;letter-spacing:0.5px;"><span class="crown-shape"></span>Chatty</p>
      <h2 style="text-align:center;margin-bottom:35px">Instructions</h2>
      
   <ul>
     <li>Double click a message to copy it.</li>
     <li style="margin-top:12px">Click a profile photo to expand it.</li>
     <li style="margin-top:12px">A message whose length is over 15,000 characters will be ignored.</li>
     <li style="margin-top:12px">Usernames should not exceed 15 characters.</li>
     <li style="margin-top:12px">‘Chatty’ is a reserved username.</li>
     <li style="margin-top:12px">If a profile picture link is invalid, it’ll be replaced with the default one.</li>
      <li style="margin-top:12px">Finally, type in <b><u style="text-underline-offset:5px">chatty</u></b> to display these instructions.</li>
   </ul>
   <h4 style="text-align:center;margin-top:34px;margin-bottom:0;color:gold">Enjoy your time!</h4>
   
     <span class="timeSpanText">10:30 PM</span>
     <img style="background:transparent;" class="profilePic" src="botLogo.png">`;

  const profilePicInput = document.getElementById('profilePicInput');
  const continueBtn = document.querySelector('.continueBtn');
  const currentUsername = document.getElementById('currentUsername');
  const currentLink = document.getElementById('currentLink');
  const usernameH3 = document.getElementById('usernameh3');
  const menu = document.querySelector('.menu-container');
  const settings = document.querySelector('.settings');

  continueBtn.addEventListener('click', () => {
    const usernameInput = document.getElementById('usernameInput');
    profilePicSrc = profilePicInput.value;
    realUsername = usernameInput.value;
    currentUsername.value = realUsername;
    currentLink.value = profilePicSrc;
    const currentProfileImg = document.getElementById('currentProfileImg');
    currentProfileImg.src = profilePicSrc;
    usernameH3.textContent = realUsername || 'Username';
    menu.style.display = 'flex';
    document.querySelector('.welcomeScreenContainer').style.display = 'none';
  })
    
   function checkNoText() { if(document.querySelector('.main').textContent.trim()) {
      document.querySelector('.noText').style.display = 'none';
    }
    }
 
   document.querySelector('.confirmBtn').addEventListener('click', () => {
     realUsername = currentUsername.value;
     profilePicSrc = currentLink.value;
     currentProfileImg.src = profilePicSrc;
     usernameH3.textContent = realUsername.length > 16 ? 'Invalid Username' : realUsername.trim().toLowerCase() == 'chatty' ? 'Reserved Username' : realUsername || 'Username';
   })

   checkNoText();
    
    function getCurrentTime() {
    const now = new Date();
    let hours = now.getHours();
    const minutes = now.getMinutes();
    const ampm = hours >= 12 ? 'PM' : 'AM';

    hours = hours % 12;
    hours = hours ? hours : 12; 
    const minutesStr = minutes < 10 ? '0' + minutes : minutes;

    const timeString = `${hours}:${minutesStr} ${ampm}`;
    return timeString;
}
    
    const socket = io();
    const message = document.getElementById('inputMessage');
    const bgColors = ['lightgray', 'gold', 'yellowgreen', 'orangered', 'orange', 'yellow', 'lightcoral', 'lightskyblue', 'blueviolet', 'hotpink'];
    const myImgBgColor = Math.round(Math.random() * 10);
     
    document.getElementById('sendBtn').addEventListener('click', () => {
      if(!message.value) {return}
      
      const meParent = document.createElement('div');
      meParent.className = 'meParent';

      const me = document.createElement('div');
      me.className = 'me';
      const myTime = getCurrentTime();

      const timeSpan = document.createElement('span');
      timeSpan.className = 'timeSpanText';
      timeSpan.textContent = myTime;
      
     me.textContent = message.value;
     meParent.appendChild(me);
     me.ondblclick = function copyContent(e) { 
        navigator.clipboard.writeText(e.currentTarget.textContent).then(function() {
            }).catch(function(error) {
                alert('Error copying: ' + error);
            });
     };
     document.querySelector('.main').appendChild(meParent);
     me.appendChild(timeSpan);
     socket.emit('chat message', message.value, myTime, realUsername, profilePicSrc, myImgBgColor);
     if (message.value.trim().toLowerCase() === 'chatty') {
       const botTemplate = document.createElement('div');
       botTemplate.className = 'notMe';
       botTemplate.innerHTML = chattyBotHTML;
       document.querySelector('.main').appendChild(botTemplate);
     }
     message.value = '';    
     window.scrollTo(0, document.body.scrollHeight);
     message.focus();
     checkNoText();
    })
    
    const number = document.getElementById('onlineNum');

    socket.on('user connect', function(num) {
      number.innerText = num;
    });
    socket.on('user disconnect', function(num) {
      number.innerText = num;
    });
    
    socket.on('chat message', function (msg, timed, username, picSrc, imgBgColor) {
      const notMe = document.createElement('div');
      notMe.className = 'notMe';
      const timedDiv = document.createElement('span');
      timedDiv.className = 'timeSpanText';
      timedDiv.textContent = getCurrentTime();
      const usernameP = document.createElement('p');
      usernameP.className = 'usernameText';
      usernameP.textContent = username;
      const messageSpan = document.createElement('span');
      messageSpan.textContent = msg;
      const picImg = document.createElement('img');
      picImg.className = 'profilePic';
      picImg.style.background = bgColors[imgBgColor];
      picImg.src = picSrc;
      picImg.onclick = function (event) {
        const picContainer = document.createElement('div');
      picContainer.className = 'profilePicViewer';
      picContainer.onclick = function (event) {
  if (event.target.tagName === 'IMG') {
    event.stopPropagation();  
    return; 
  }
  picContainer.style.display = 'none';
};
      const pic = document.createElement('img');
      pic.className = 'profilePicViewed';
      pic.src = event.currentTarget.src;
      picContainer.appendChild(pic);
      document.body.appendChild(picContainer);
      }
      notMe.appendChild(usernameP);
      notMe.appendChild(messageSpan);
      notMe.appendChild(timedDiv);
      notMe.appendChild(picImg);
      picImg.onerror = function validateProfilePic(e) {
          e.currentTarget.src = "profilePic.png";
        }
      notMe.ondblclick = function copyContent(e) { 
        navigator.clipboard.writeText(e.currentTarget.textContent).then(function() {
            }).catch(function(error) {
                alert('Error copying: ' + error);
            });
     };
      document.querySelector('.main').appendChild(notMe);
      window.scrollTo(0, document.body.scrollHeight);
      checkNoText();      
    })


    menu.addEventListener('click', () => {
      settings.classList.toggle('settingsToggle');
    })
    
    setInterval(function () {
       const botTemplate = document.createElement('div');
       botTemplate.className = 'notMe';
       botTemplate.innerHTML = chattyBotHTML;
       document.querySelector('.main').appendChild(botTemplate);
       checkNoText();
    }, 300000);
    
  </script>
  
</body>
</html>
